
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Master class</title><meta name="generator" content="MATLAB 9.7"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2022-05-01"><meta name="DC.source" content="Master.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Master class</h1><!--introduction--><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Description</a></li><li><a href="#2">Public properties</a></li><li><a href="#3">Constructor method</a></li><li><a href="#4">Public methods: main functions</a></li><li><a href="#5">Public methods: auxiliary functions</a></li></ul></div><h2 id="1">Description</h2><p>This is the main class for running simulations and tests in DEMLab.</p><p>It is responsible for managing the high-level tasks and call the appropriate methods to perform each stage of a simulation, from the reading of input files to the showing of results.</p><pre class="codeinput"><span class="keyword">classdef</span> Master &lt; handle
</pre><h2 id="2">Public properties</h2><pre class="codeinput">    properties (SetAccess = public, GetAccess = public)
        echo     <span class="string">uint8</span>   <span class="string">=</span> <span class="string">uint8.empty</span>;     <span class="comment">% echo level (amount of information to be printed in command window)</span>
        path_in  <span class="string">string</span>  <span class="string">=</span> <span class="string">string.empty</span>;    <span class="comment">% path to input files folder</span>
        files    <span class="string">string</span>  <span class="string">=</span> <span class="string">string.empty</span>;    <span class="comment">% full name of input files (with path)</span>
        cur_file <span class="string">string</span>  <span class="string">=</span> <span class="string">string.empty</span>;    <span class="comment">% name of current file being run</span>
        is_last  <span class="string">logical</span> <span class="string">=</span> <span class="string">logical.empty</span>;   <span class="comment">% flag for last input file to run</span>
    <span class="keyword">end</span>
</pre><h2 id="3">Constructor method</h2><pre class="codeinput">    methods
        <span class="keyword">function</span> this = Master()
            this.setDefaultProps();
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><h2 id="4">Public methods: main functions</h2><pre class="codeinput">    methods
        <span class="comment">%------------------------------------------------------------------</span>
        <span class="keyword">function</span> setDefaultProps(this)
            this.echo = 1;
        <span class="keyword">end</span>

        <span class="comment">%------------------------------------------------------------------</span>
        <span class="keyword">function</span> runSimulations(this,echo)
            <span class="keyword">if</span> (nargin &gt; 1)
                this.echo = echo;
            <span class="keyword">end</span>

            <span class="comment">% Print header</span>
            this.printHeader();

            <span class="comment">% Get input files</span>
            <span class="keyword">if</span> (~this.getInputFiles())
                <span class="keyword">return</span>;
            <span class="keyword">end</span>

            <span class="comment">% Display input files</span>
            this.displayInputFiles();

            <span class="comment">% Run each input file</span>
            <span class="keyword">for</span> i = 1:length(this.files)
                this.is_last = (i == length(this.files));

                <span class="comment">% Clear driver</span>
                clearvars <span class="string">drv</span>;

                <span class="comment">% Get current file name and extension</span>
                this.cur_file = this.files(i);
                [~,~,ext] = fileparts(this.cur_file);

                <span class="comment">% Run according to file extension</span>
                <span class="keyword">if</span> (strcmp(ext,<span class="string">'.json'</span>))
                    [status,drv] = this.runAnalysis();
                    <span class="keyword">if</span> (~status)
                        <span class="keyword">continue</span>;
                    <span class="keyword">end</span>
                <span class="keyword">elseif</span> (strcmp(ext,<span class="string">'.mat'</span>))
                    [status,drv] = this.loadResults();
                    <span class="keyword">if</span> (~status)
                        <span class="keyword">continue</span>;
                    <span class="keyword">end</span>
                <span class="keyword">else</span>
                    fprintf(<span class="string">'Input file:\n%s\n'</span>,this.cur_file);
                    fprintf(2,<span class="string">'\nInvalid input file extension.\n'</span>);
                    this.printExit();
                    <span class="keyword">continue</span>;
                <span class="keyword">end</span>

                <span class="comment">% Pos-process</span>
                drv.posProcess();

                <span class="comment">% Finish current analysis</span>
                fprintf(<span class="string">'\nFinished!\n'</span>);
                <span class="keyword">if</span> (~this.is_last)
                    fprintf(<span class="string">'\n------------------------------------------------------------------\n\n'</span>);
                <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>

        <span class="comment">%------------------------------------------------------------------</span>
        <span class="keyword">function</span> runTests(this,mode)
            this.echo = 0;

            <span class="comment">% Print header</span>
            this.printHeader();

            <span class="comment">% Check input</span>
            <span class="keyword">if</span> (mode ~= 1 &amp;&amp; mode ~= 2)
                fprintf(<span class="string">'Invalid testing mode!\n'</span>);
                fprintf(<span class="string">'\nExiting program...\n'</span>);
                <span class="keyword">return</span>;
            <span class="keyword">end</span>

            <span class="comment">% Get input files</span>
            <span class="keyword">if</span> (~this.getInputFiles())
                <span class="keyword">return</span>;
            <span class="keyword">end</span>

            <span class="comment">% Display input files</span>
            this.displayInputFiles();

            <span class="comment">% Run each input file</span>
            <span class="keyword">for</span> i = 1:length(this.files)
                this.is_last = (i == length(this.files));

                <span class="comment">% Clear driver</span>
                clearvars <span class="string">drv</span>;

                <span class="comment">% Get current file name and extension</span>
                this.cur_file = this.files(i);
                [~,~,ext] = fileparts(this.cur_file);
                <span class="keyword">if</span> (~strcmp(ext,<span class="string">'.json'</span>))
                    fprintf(<span class="string">'Input file:\n%s\n'</span>,this.cur_file);
                    fprintf(2,<span class="string">'\nInvalid input file extension.\n'</span>);
                    this.printExit();
                    <span class="keyword">continue</span>;
                <span class="keyword">end</span>

                <span class="comment">% Run simulation</span>
                [status,drv] = this.runAnalysis();
                <span class="keyword">if</span> (~status)
                    <span class="keyword">continue</span>;
                <span class="keyword">end</span>

                <span class="comment">% Pos-process</span>
                drv.posProcess();

                <span class="comment">% Perform action according to testing mode</span>
                <span class="keyword">if</span> (mode == 1) <span class="comment">% compare results file with reference</span>
                    this.compareTest(drv);
                <span class="keyword">elseif</span> (mode == 2) <span class="comment">% generate/update reference results</span>
                   this.renameRefResultFile(drv);
                <span class="keyword">end</span>

                <span class="comment">% Finish current analysis</span>
                <span class="keyword">if</span> (~this.is_last)
                    fprintf(<span class="string">'\n------------------------------------------------------------------\n\n'</span>);
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            fprintf(<span class="string">'\nFinished!\n'</span>);
        <span class="keyword">end</span>

        <span class="comment">%------------------------------------------------------------------</span>
        <span class="keyword">function</span> [status,drv] = runAnalysis(this)
            <span class="comment">% Open parameters file</span>
            fprintf(<span class="string">'Parameters file:\n%s\n'</span>,this.cur_file);
            fid = fopen(this.cur_file,<span class="string">'rt'</span>);
            <span class="keyword">if</span> (fid &lt; 0)
                fprintf(2,<span class="string">'\nError opening parameters file.\n'</span>);
                this.printExit();
                status = 0;
                <span class="keyword">return</span>;
            <span class="keyword">end</span>

            <span class="comment">% Read parameters file</span>
            <span class="keyword">if</span> (this.echo &gt; 0)
                fprintf(<span class="string">'\nReading parameters file...\n'</span>);
            <span class="keyword">end</span>
            read = Read();
            [status,drv,storage_file] = read.execute(this.path_in,fid);

            <span class="comment">% Pre analysis tasks</span>
            <span class="keyword">if</span> (status == 0)
                this.printExit();
                <span class="keyword">return</span>;

            <span class="keyword">elseif</span> (status == 1) <span class="comment">% start analysis from the beggining</span>
                <span class="comment">% Check input data</span>
                <span class="keyword">if</span> (this.echo &gt; 0)
                    fprintf(<span class="string">'\nChecking consistency of input data...\n'</span>);
                <span class="keyword">end</span>
                <span class="keyword">if</span> (~read.check(drv))
                    this.printExit();
                    status = 0;
                    <span class="keyword">return</span>;
                <span class="keyword">end</span>

                <span class="comment">% Pre-process</span>
                <span class="keyword">if</span> (this.echo &gt; 0)
                    fprintf(<span class="string">'\nPre-processing...\n'</span>);
                <span class="keyword">end</span>
                <span class="keyword">if</span> (~drv.preProcess())
                    this.printExit();
                    status = 0;
                    <span class="keyword">return</span>;
                <span class="keyword">end</span>

                <span class="comment">% Print simulation information</span>
                <span class="keyword">if</span> (this.echo &gt; 0)
                    this.printSimulationInfo(drv);
                    fprintf(<span class="string">'\nStarting analysis:\n'</span>);
                    fprintf(<span class="string">'%s\n'</span>,datestr(now));
                <span class="keyword">end</span>

            <span class="keyword">elseif</span> (status == 2) <span class="comment">% continue analysis from previous state</span>
                f = dir(storage_file);
                fprintf(<span class="string">'\nStorage file found (%.3f Mb):\n%s\n'</span>,f.bytes/10e5,storage_file);

                <span class="comment">% Load storage file</span>
                [loaded,drv] = this.loadStorageFile(storage_file);
                <span class="keyword">if</span> (~loaded)
                    status = 0;
                    <span class="keyword">return</span>;
                <span class="keyword">end</span>

                <span class="comment">% Set output folder to current folder</span>
                drv.path_out = this.path_in;

                <span class="comment">% Update starting elapsed time</span>
                drv.start_time = drv.total_time;

                <span class="comment">% Print simulation information</span>
                <span class="keyword">if</span> (this.echo &gt; 0)
                    this.printSimulationInfo(drv);
                    fprintf(<span class="string">'\nStarting analysis from previous results:\n'</span>);
                    fprintf(<span class="string">'%s\n'</span>,datestr(now));
                <span class="keyword">end</span>
            <span class="keyword">end</span>

            <span class="comment">% Show starting configuration</span>
            <span class="keyword">if</span> (this.echo &gt; 0)
                Animation().curConfig(drv,<span class="string">'Starting'</span>);
            <span class="keyword">end</span>

            <span class="comment">% Execute analysis</span>
            tic;
            drv.process();

            <span class="comment">% Print finished status</span>
            <span class="keyword">if</span> (this.echo &gt; 0)
                this.printFinishedStatus(drv,status);
            <span class="keyword">end</span>
        <span class="keyword">end</span>

        <span class="comment">%------------------------------------------------------------------</span>
        <span class="keyword">function</span> [status,drv] = loadResults(this)
            status = 1;
            f = dir(this.cur_file);
            fprintf(<span class="string">'Storage file (%.3f Mb):\n%s\n'</span>,f.bytes/10e5,this.cur_file);

            <span class="comment">% Load storage file</span>
            [loaded,drv] = this.loadStorageFile(this.cur_file);
            <span class="keyword">if</span> (~loaded)
                status = 0;
                <span class="keyword">return</span>;
            <span class="keyword">end</span>

            <span class="comment">% Set output folder to current folder</span>
            drv.path_out = this.path_in;

            <span class="comment">% Show current configuration</span>
            <span class="keyword">if</span> (this.echo &gt; 0)
                Animation().curConfig(drv,<span class="string">''</span>);
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><h2 id="5">Public methods: auxiliary functions</h2><pre class="codeinput">    methods
        <span class="comment">%------------------------------------------------------------------</span>
        <span class="keyword">function</span> printHeader(~)
            fprintf(<span class="string">'==================================================================\n'</span>);
            fprintf(<span class="string">'           DEMLab - Discrete Element Method Laboratory            \n'</span>);
            fprintf(<span class="string">'                      Version 1.0 - May 2022                      \n'</span>);
            fprintf(<span class="string">' International Center for Numerical Methods in Engineering (CIMNE)\n'</span>);
            fprintf(<span class="string">'      Polytechnic University of Catalonia (UPC BarcelonaTech)     \n'</span>);
            fprintf(<span class="string">'==================================================================\n\n'</span>);
        <span class="keyword">end</span>

        <span class="comment">%------------------------------------------------------------------</span>
        <span class="keyword">function</span> status = getInputFiles(this)
            status  = 1;

            <span class="comment">% Get files from dialog</span>
            filter  = {<span class="string">'*.json'</span>,<span class="string">'Parameters File (*.json)'</span>;<span class="string">'*.mat'</span>,<span class="string">'Storage File (*.mat)'</span>};
            title   = <span class="string">'DEMLab - Input file'</span>;
            default = <span class="string">'ProjectParameters.json'</span>;
            [file_names,path] = uigetfile(filter,title,default,<span class="string">'MultiSelect'</span>,<span class="string">'on'</span>);
            <span class="keyword">if</span> (isequal(file_names,0))
                fprintf(<span class="string">'No file selected.\n'</span>);
                fprintf(<span class="string">'\nExiting program...\n'</span>);
                status = 0;
                <span class="keyword">return</span>;
            <span class="keyword">end</span>
            file_fullnames = fullfile(path,file_names);

            <span class="comment">% Convert to string array</span>
            this.files   = string(file_fullnames);
            this.path_in = string(path);
        <span class="keyword">end</span>

        <span class="comment">%------------------------------------------------------------------</span>
        <span class="keyword">function</span> displayInputFiles(this)
            n_files = length(this.files);
            fprintf(<span class="string">'%d input files selected:\n'</span>,n_files);
            <span class="keyword">for</span> i = 1:n_files
                fprintf(<span class="string">'%s\n'</span>,this.files(i));
            <span class="keyword">end</span>
            fprintf(<span class="string">'\n------------------------------------------------------------------\n\n'</span>);
        <span class="keyword">end</span>

        <span class="comment">%------------------------------------------------------------------</span>
        <span class="keyword">function</span> printSimulationInfo(~,drv)
            fprintf(<span class="string">'\nSimulation ready:\n'</span>);
            <span class="keyword">if</span> (~isempty(drv.name))
                fprintf(<span class="string">'Name...................: %s\n'</span>,drv.name);
            <span class="keyword">end</span>
            <span class="keyword">switch</span> drv.type
                <span class="keyword">case</span> drv.MECHANICAL
                    fprintf(<span class="string">'Type...................: Mechanical\n'</span>);
                <span class="keyword">case</span> drv.type == drv.THERMAL
                    fprintf(<span class="string">'Type...................: Thermal\n'</span>);
                <span class="keyword">case</span> drv.THERMO_MECHANICAL
                    fprintf(<span class="string">'Type...................: Thermo-mechanical\n'</span>);
            <span class="keyword">end</span>
            <span class="keyword">if</span> (~isempty(drv.n_walls))
                fprintf(<span class="string">'Number of walls........: %d\n'</span>,drv.n_walls);
            <span class="keyword">end</span>
            <span class="keyword">if</span> (~isempty(drv.n_particles))
                fprintf(<span class="string">'Number of particles....: %d\n'</span>,drv.n_particles);
            <span class="keyword">end</span>
            <span class="keyword">if</span> (~isempty(drv.particles))
                ravg = mean([drv.particles.radius]);
                rdev = std([drv.particles.radius]);
                rmin = min([drv.particles.radius]);
                rmax = max([drv.particles.radius]);
                <span class="keyword">if</span> (rdev/rmin &lt; 1e-8)
                    rdev = 0;
                <span class="keyword">end</span>
                fprintf(<span class="string">'Average radius.........: %.3e\n'</span>,ravg);
                fprintf(<span class="string">'Radius deviation.......: %.3e\n'</span>,rdev);
                <span class="keyword">if</span> (rdev ~= 0)
                    fprintf(<span class="string">'Min radius.............: %.3e\n'</span>,rmin);
                    fprintf(<span class="string">'Max radius.............: %.3e\n'</span>,rmax);
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            <span class="keyword">if</span> (~isempty(drv.particles) &amp;&amp;<span class="keyword">...</span>
               (drv.type == drv.THERMAL || drv.type == drv.THERMO_MECHANICAL))
                tavg = mean([drv.particles.temperature]);
                tdev = std([drv.particles.temperature]);
                tmin = min([drv.particles.temperature]);
                tmax = max([drv.particles.temperature]);
                fprintf(<span class="string">'Average temperature....: %.3e\n'</span>,tavg);
                fprintf(<span class="string">'Temperature deviation..: %.3e\n'</span>,tdev);
                <span class="keyword">if</span> (tdev ~= 0)
                    fprintf(<span class="string">'Min temperature........: %.3e\n'</span>,tmin);
                    fprintf(<span class="string">'Max temperature........: %.3e\n'</span>,tmax);
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            <span class="keyword">if</span> (~isempty(drv.mass_particle))
                fprintf(<span class="string">'Total mass.............: %.3e\n'</span>,drv.mass_particle);
            <span class="keyword">end</span>
            <span class="keyword">if</span> (~isempty(drv.time_step))
                fprintf(<span class="string">'Time step..............: %.3e\n'</span>,drv.time_step);
            <span class="keyword">end</span>
            <span class="keyword">if</span> (~isempty(drv.max_time))
                fprintf(<span class="string">'Final time.............: %f\n'</span>,drv.max_time);
            <span class="keyword">end</span>
        <span class="keyword">end</span>

        <span class="comment">%------------------------------------------------------------------</span>
        <span class="keyword">function</span> printFinishedStatus(~,drv,status)
            fprintf(<span class="string">'\n\nAnalysis finished:\n'</span>);
            fprintf(<span class="string">'%s\n'</span>,datestr(now));
            <span class="keyword">if</span> (status == 1)
                time            = seconds(toc);
                avg_time        = time/drv.step;
                time.Format     = <span class="string">'hh:mm:ss.SS'</span>;
                avg_time.Format = <span class="string">'s'</span>;
                fprintf(<span class="string">'Total time:.....: %s\n'</span>,string(time));
                fprintf(<span class="string">'Avg step time:..: %s\n'</span>,string(avg_time));
            <span class="keyword">elseif</span> (status == 2)
                curr_time         = seconds(toc);
                total_time        = seconds(drv.total_time);
                avg_time          = total_time/drv.step;
                curr_time.Format  = <span class="string">'hh:mm:ss.SS'</span>;
                total_time.Format = <span class="string">'hh:mm:ss.SS'</span>;
                avg_time.Format   = <span class="string">'s'</span>;
                fprintf(<span class="string">'Current analysis time:..: %s\n'</span>,string(curr_time));
                fprintf(<span class="string">'Total simulation time:..: %s\n'</span>,string(total_time));
                fprintf(<span class="string">'Avg step time:..........: %s\n'</span>,string(avg_time));
            <span class="keyword">end</span>
        <span class="keyword">end</span>

        <span class="comment">%------------------------------------------------------------------</span>
        <span class="keyword">function</span> printExit(this)
            <span class="keyword">if</span> (this.is_last)
                fprintf(<span class="string">'\nExiting program...\n'</span>);
            <span class="keyword">else</span>
                fprintf(<span class="string">'\nAborted!\n'</span>);
                fprintf(<span class="string">'\n------------------------------------------------------------------\n\n'</span>);
            <span class="keyword">end</span>
        <span class="keyword">end</span>

        <span class="comment">%------------------------------------------------------------------</span>
        <span class="keyword">function</span> [status,drv] = loadStorageFile(this,storage_file)
            status = 1;
            <span class="keyword">try</span>
                warning <span class="string">off</span> <span class="string">MATLAB:load:variableNotFound</span>
                load(storage_file,<span class="string">'drv'</span>);
                warning <span class="string">on</span> <span class="string">MATLAB:load:variableNotFound</span>
            <span class="keyword">catch</span>
                fprintf(2,<span class="string">'\nError loading storage file.\n'</span>);
                this.printExit();
                status = 0;
                <span class="keyword">return</span>;
            <span class="keyword">end</span>
            <span class="keyword">if</span> (~exist(<span class="string">'drv'</span>,<span class="string">'var'</span>) || isempty(drv))
                fprintf(2,<span class="string">'\nInvalid stored data.\n'</span>);
                this.printExit();
                status = 0;
                <span class="keyword">return</span>;
            <span class="keyword">end</span>
        <span class="keyword">end</span>

        <span class="comment">%------------------------------------------------------------------</span>
        <span class="keyword">function</span> compareTest(this,drv)
            <span class="comment">% Check if reference and current results files exist</span>
            name_ref = strcat(drv.path_in,drv.name,<span class="string">"_ref.pos"</span>);
            name_cur = strcat(drv.path_out,drv.name,<span class="string">".pos"</span>);
            <span class="keyword">if</span> (exist(name_ref,<span class="string">'file'</span>) ~= 2)
                fprintf(2,<span class="string">'\nMissing reference results file!\n'</span>);
                this.deleteFile(name_cur);
                status = rmdir(drv.path_out); <span class="comment">%#ok&lt;NASGU&gt;</span>
                <span class="keyword">return</span>;
            <span class="keyword">end</span>
            <span class="keyword">if</span> (exist(name_cur,<span class="string">'file'</span>) ~= 2)
                fprintf(2,<span class="string">'\nCurrent results file was not generated correctly!\n'</span>);
                this.deleteFile(name_cur);
                status = rmdir(drv.path_out); <span class="comment">%#ok&lt;NASGU&gt;</span>
                <span class="keyword">return</span>;
            <span class="keyword">end</span>

            <span class="comment">% Compare contents of files</span>
            file_ref = javaObject(<span class="string">'java.io.File'</span>,name_ref);
            file_cur = javaObject(<span class="string">'java.io.File'</span>,name_cur);
            is_equal = javaMethod(<span class="string">'contentEquals'</span>,<span class="string">'org.apache.commons.io.FileUtils'</span>,file_ref,file_cur);
            <span class="keyword">if</span> (is_equal)
                fprintf(1,<span class="string">'\nTest passed!\n'</span>);
            <span class="keyword">else</span>
                fprintf(2,<span class="string">'\nResults are different!\n'</span>);
            <span class="keyword">end</span>

            <span class="comment">% Delete current results file and folder (if empty)</span>
            this.deleteFile(name_cur);
            status = rmdir(drv.path_out); <span class="comment">%#ok&lt;NASGU&gt;</span>
        <span class="keyword">end</span>

        <span class="comment">%------------------------------------------------------------------</span>
        <span class="keyword">function</span> renameRefResultFile(this,drv)
            <span class="comment">% Check if current results file exist</span>
            name_cur = strcat(drv.path_out,drv.name,<span class="string">".pos"</span>);
            <span class="keyword">if</span> (exist(name_cur,<span class="string">'file'</span>) ~= 2)
                fprintf(2,<span class="string">'\nCurrent results file was not generated correctly!\n'</span>);
                this.deleteFile(name_cur);
                status = rmdir(drv.path_out); <span class="comment">%#ok&lt;NASGU&gt;</span>
                <span class="keyword">return</span>;
            <span class="keyword">end</span>

            <span class="comment">% Move current results file out of output folder</span>
            <span class="keyword">if</span> (~movefile(name_cur,drv.path_in))
                fprintf(2,<span class="string">'\nCurrent results file was not generated correctly!\n'</span>);
                this.deleteFile(name_cur);
                status = rmdir(drv.path_out); <span class="comment">%#ok&lt;NASGU&gt;</span>
                <span class="keyword">return</span>;
            <span class="keyword">end</span>

            <span class="comment">% Delete output folder (if empty)</span>
            status = rmdir(drv.path_out); <span class="comment">%#ok&lt;NASGU&gt;</span>

            <span class="comment">% Rename current results file to reference results file</span>
            name_cur = strcat(drv.path_in,drv.name,<span class="string">".pos"</span>);
            name_ref = strcat(drv.path_in,drv.name,<span class="string">"_ref.pos"</span>);
            movefile(name_cur,name_ref);
            fprintf(1,<span class="string">'\nReference results generated!\n'</span>);
        <span class="keyword">end</span>

        <span class="comment">%------------------------------------------------------------------</span>
        <span class="keyword">function</span> deleteFile(~,file_name)
            <span class="keyword">if</span> (exist(file_name,<span class="string">'file'</span>) == 2)
                warning <span class="string">off</span> <span class="string">MATLAB:DELETE:FileNotFound</span>
                delete(sprintf(<span class="string">'%s'</span>,file_name));
                warning <span class="string">on</span> <span class="string">MATLAB:DELETE:FileNotFound</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>

        <span class="comment">%------------------------------------------------------------------</span>
        <span class="comment">% To be called before the analysis (currently not available)</span>
        <span class="keyword">function</span> startParallel(~,drv)
            p = gcp(<span class="string">'nocreate'</span>);
            <span class="keyword">if</span> (drv.parallel)
                max_workers = parcluster(<span class="string">'local'</span>).NumWorkers;
                <span class="keyword">if</span> (drv.workers &gt; max_workers)
                    drv.workers = max_workers;
                    warning(<span class="string">'off'</span>,<span class="string">'backtrace'</span>);
                    warning(<span class="string">'The selected number of workers is greater than the available number of workers in this machine. The simulation will proceed with the %d available workers'</span>,max_workers);
                    warning(<span class="string">'on'</span>,<span class="string">'backtrace'</span>);
                <span class="keyword">end</span>
                <span class="keyword">if</span> (isempty(p))
                    fprintf(<span class="string">'\n'</span>);
                    parpool(drv.workers);
                <span class="keyword">elseif</span> (p.NumWorkers ~= drv.workers)
                    fprintf(<span class="string">'\n'</span>);
                    delete(p)
                    parpool(drv.workers);
                <span class="keyword">end</span>
            <span class="keyword">elseif</span> (~isempty(p))
                fprintf(<span class="string">'\n'</span>);
                delete(p);
            <span class="keyword">end</span>
            ps = parallel.Settings;
            ps.Pool.AutoCreate = false;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2019b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Master class
%
%% Description
%
% This is the main class for running simulations and tests in DEMLab.
%
% It is responsible for managing the high-level tasks and call the
% appropriate methods to perform each stage of a simulation, from the
% reading of input files to the showing of results.
%
classdef Master < handle
    %% Public properties
    properties (SetAccess = public, GetAccess = public)
        echo     uint8   = uint8.empty;     % echo level (amount of information to be printed in command window)
        path_in  string  = string.empty;    % path to input files folder
        files    string  = string.empty;    % full name of input files (with path)
        cur_file string  = string.empty;    % name of current file being run
        is_last  logical = logical.empty;   % flag for last input file to run
    end
    
    %% Constructor method
    methods
        function this = Master()
            this.setDefaultProps();
        end
    end
    
    %% Public methods: main functions
    methods
        %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
        function setDefaultProps(this)
            this.echo = 1;
        end
        
        %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
        function runSimulations(this,echo)
            if (nargin > 1)
                this.echo = echo;
            end
            
            % Print header
            this.printHeader();
            
            % Get input files
            if (~this.getInputFiles())
                return;
            end
            
            % Display input files
            this.displayInputFiles();
            
            % Run each input file
            for i = 1:length(this.files)
                this.is_last = (i == length(this.files));
                
                % Clear driver
                clearvars drv;
                
                % Get current file name and extension
                this.cur_file = this.files(i);
                [~,~,ext] = fileparts(this.cur_file);
                
                % Run according to file extension
                if (strcmp(ext,'.json'))
                    [status,drv] = this.runAnalysis();
                    if (~status)
                        continue;
                    end
                elseif (strcmp(ext,'.mat'))
                    [status,drv] = this.loadResults();
                    if (~status)
                        continue;
                    end
                else
                    fprintf('Input file:\n%s\n',this.cur_file);
                    fprintf(2,'\nInvalid input file extension.\n');
                    this.printExit();
                    continue;
                end
                
                % Pos-process
                drv.posProcess();
                
                % Finish current analysis
                fprintf('\nFinished!\n');
                if (~this.is_last)
                    fprintf('\nREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH\n\n');
                end
            end
        end
        
        %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
        function runTests(this,mode)
            this.echo = 0;
            
            % Print header
            this.printHeader();
            
            % Check input
            if (mode ~= 1 && mode ~= 2)
                fprintf('Invalid testing mode!\n');
                fprintf('\nExiting program...\n');
                return;
            end
            
            % Get input files
            if (~this.getInputFiles())
                return;
            end
            
            % Display input files
            this.displayInputFiles();
            
            % Run each input file
            for i = 1:length(this.files)
                this.is_last = (i == length(this.files));
                
                % Clear driver
                clearvars drv;
                
                % Get current file name and extension
                this.cur_file = this.files(i);
                [~,~,ext] = fileparts(this.cur_file);
                if (~strcmp(ext,'.json'))
                    fprintf('Input file:\n%s\n',this.cur_file);
                    fprintf(2,'\nInvalid input file extension.\n');
                    this.printExit();
                    continue;
                end
                
                % Run simulation
                [status,drv] = this.runAnalysis();
                if (~status)
                    continue;
                end
                
                % Pos-process
                drv.posProcess();
                
                % Perform action according to testing mode
                if (mode == 1) % compare results file with reference
                    this.compareTest(drv);
                elseif (mode == 2) % generate/update reference results
                   this.renameRefResultFile(drv); 
                end
                
                % Finish current analysis
                if (~this.is_last)
                    fprintf('\nREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH\n\n');
                end
            end
            fprintf('\nFinished!\n');
        end
        
        %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
        function [status,drv] = runAnalysis(this)
            % Open parameters file
            fprintf('Parameters file:\n%s\n',this.cur_file);
            fid = fopen(this.cur_file,'rt');
            if (fid < 0)
                fprintf(2,'\nError opening parameters file.\n');
                this.printExit();
                status = 0;
                return;
            end
            
            % Read parameters file
            if (this.echo > 0)
                fprintf('\nReading parameters file...\n');
            end
            read = Read();
            [status,drv,storage_file] = read.execute(this.path_in,fid);
            
            % Pre analysis tasks
            if (status == 0)
                this.printExit();
                return;
                
            elseif (status == 1) % start analysis from the beggining
                % Check input data
                if (this.echo > 0)
                    fprintf('\nChecking consistency of input data...\n');
                end
                if (~read.check(drv))
                    this.printExit();
                    status = 0;
                    return;
                end
                
                % Pre-process
                if (this.echo > 0)
                    fprintf('\nPre-processing...\n');
                end
                if (~drv.preProcess())
                    this.printExit();
                    status = 0;
                    return;
                end
                
                % Print simulation information
                if (this.echo > 0)
                    this.printSimulationInfo(drv);
                    fprintf('\nStarting analysis:\n');
                    fprintf('%s\n',datestr(now));
                end
                
            elseif (status == 2) % continue analysis from previous state
                f = dir(storage_file);
                fprintf('\nStorage file found (%.3f Mb):\n%s\n',f.bytes/10e5,storage_file);
                
                % Load storage file
                [loaded,drv] = this.loadStorageFile(storage_file);
                if (~loaded)
                    status = 0;
                    return;
                end
                
                % Set output folder to current folder
                drv.path_out = this.path_in;
                
                % Update starting elapsed time
                drv.start_time = drv.total_time;
                
                % Print simulation information
                if (this.echo > 0)
                    this.printSimulationInfo(drv);
                    fprintf('\nStarting analysis from previous results:\n');
                    fprintf('%s\n',datestr(now));
                end
            end
            
            % Show starting configuration
            if (this.echo > 0)
                Animation().curConfig(drv,'Starting');
            end
            
            % Execute analysis
            tic;
            drv.process();
            
            % Print finished status
            if (this.echo > 0)
                this.printFinishedStatus(drv,status);
            end
        end
        
        %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
        function [status,drv] = loadResults(this)
            status = 1;
            f = dir(this.cur_file);
            fprintf('Storage file (%.3f Mb):\n%s\n',f.bytes/10e5,this.cur_file);
            
            % Load storage file
            [loaded,drv] = this.loadStorageFile(this.cur_file);
            if (~loaded)
                status = 0;
                return;
            end
            
            % Set output folder to current folder
            drv.path_out = this.path_in;
            
            % Show current configuration
            if (this.echo > 0)
                Animation().curConfig(drv,'');
            end
        end
    end
    
    %% Public methods: auxiliary functions
    methods
        %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
        function printHeader(~)
            fprintf('==================================================================\n');
            fprintf('           DEMLab - Discrete Element Method Laboratory            \n');
            fprintf('                      Version 1.0 - May 2022                      \n');
            fprintf(' International Center for Numerical Methods in Engineering (CIMNE)\n');
            fprintf('      Polytechnic University of Catalonia (UPC BarcelonaTech)     \n');
            fprintf('==================================================================\n\n');
        end
        
        %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
        function status = getInputFiles(this)
            status  = 1;
            
            % Get files from dialog
            filter  = {'*.json','Parameters File (*.json)';'*.mat','Storage File (*.mat)'};
            title   = 'DEMLab - Input file';
            default = 'ProjectParameters.json';
            [file_names,path] = uigetfile(filter,title,default,'MultiSelect','on');
            if (isequal(file_names,0))
                fprintf('No file selected.\n');
                fprintf('\nExiting program...\n');
                status = 0;
                return;
            end
            file_fullnames = fullfile(path,file_names);
            
            % Convert to string array
            this.files   = string(file_fullnames);
            this.path_in = string(path);
        end
        
        %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
        function displayInputFiles(this)
            n_files = length(this.files);
            fprintf('%d input files selected:\n',n_files);
            for i = 1:n_files
                fprintf('%s\n',this.files(i));
            end
            fprintf('\nREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH\n\n');
        end
        
        %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
        function printSimulationInfo(~,drv)
            fprintf('\nSimulation ready:\n');
            if (~isempty(drv.name))
                fprintf('Name...................: %s\n',drv.name);
            end
            switch drv.type
                case drv.MECHANICAL
                    fprintf('Type...................: Mechanical\n');
                case drv.type == drv.THERMAL
                    fprintf('Type...................: Thermal\n');
                case drv.THERMO_MECHANICAL
                    fprintf('Type...................: Thermo-mechanical\n');
            end
            if (~isempty(drv.n_walls))
                fprintf('Number of walls........: %d\n',drv.n_walls);
            end
            if (~isempty(drv.n_particles))
                fprintf('Number of particles....: %d\n',drv.n_particles);
            end
            if (~isempty(drv.particles))
                ravg = mean([drv.particles.radius]);
                rdev = std([drv.particles.radius]);
                rmin = min([drv.particles.radius]);
                rmax = max([drv.particles.radius]);
                if (rdev/rmin < 1e-8)
                    rdev = 0;
                end
                fprintf('Average radius.........: %.3e\n',ravg);
                fprintf('Radius deviation.......: %.3e\n',rdev);
                if (rdev ~= 0)
                    fprintf('Min radius.............: %.3e\n',rmin);
                    fprintf('Max radius.............: %.3e\n',rmax);
                end
            end
            if (~isempty(drv.particles) &&...
               (drv.type == drv.THERMAL || drv.type == drv.THERMO_MECHANICAL))
                tavg = mean([drv.particles.temperature]);
                tdev = std([drv.particles.temperature]);
                tmin = min([drv.particles.temperature]);
                tmax = max([drv.particles.temperature]);
                fprintf('Average temperature....: %.3e\n',tavg);
                fprintf('Temperature deviation..: %.3e\n',tdev);
                if (tdev ~= 0)
                    fprintf('Min temperature........: %.3e\n',tmin);
                    fprintf('Max temperature........: %.3e\n',tmax);
                end
            end
            if (~isempty(drv.mass_particle))
                fprintf('Total mass.............: %.3e\n',drv.mass_particle);
            end
            if (~isempty(drv.time_step))
                fprintf('Time step..............: %.3e\n',drv.time_step);
            end
            if (~isempty(drv.max_time))
                fprintf('Final time.............: %f\n',drv.max_time);
            end
        end
        
        %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
        function printFinishedStatus(~,drv,status)
            fprintf('\n\nAnalysis finished:\n');
            fprintf('%s\n',datestr(now));
            if (status == 1)
                time            = seconds(toc);
                avg_time        = time/drv.step;
                time.Format     = 'hh:mm:ss.SS';
                avg_time.Format = 's';
                fprintf('Total time:.....: %s\n',string(time));
                fprintf('Avg step time:..: %s\n',string(avg_time));
            elseif (status == 2)
                curr_time         = seconds(toc);
                total_time        = seconds(drv.total_time);
                avg_time          = total_time/drv.step;
                curr_time.Format  = 'hh:mm:ss.SS';
                total_time.Format = 'hh:mm:ss.SS';
                avg_time.Format   = 's';
                fprintf('Current analysis time:..: %s\n',string(curr_time));
                fprintf('Total simulation time:..: %s\n',string(total_time));
                fprintf('Avg step time:..........: %s\n',string(avg_time));
            end
        end
        
        %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
        function printExit(this)
            if (this.is_last)
                fprintf('\nExiting program...\n');
            else
                fprintf('\nAborted!\n');
                fprintf('\nREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH\n\n');
            end
        end
        
        %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
        function [status,drv] = loadStorageFile(this,storage_file)
            status = 1;
            try
                warning off MATLAB:load:variableNotFound
                load(storage_file,'drv');
                warning on MATLAB:load:variableNotFound
            catch
                fprintf(2,'\nError loading storage file.\n');
                this.printExit();
                status = 0;
                return;
            end
            if (~exist('drv','var') || isempty(drv))
                fprintf(2,'\nInvalid stored data.\n');
                this.printExit();
                status = 0;
                return;
            end
        end
        
        %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
        function compareTest(this,drv)
            % Check if reference and current results files exist
            name_ref = strcat(drv.path_in,drv.name,"_ref.pos");
            name_cur = strcat(drv.path_out,drv.name,".pos");
            if (exist(name_ref,'file') ~= 2)
                fprintf(2,'\nMissing reference results file!\n');
                this.deleteFile(name_cur);
                status = rmdir(drv.path_out); %#ok<NASGU>
                return;
            end
            if (exist(name_cur,'file') ~= 2)
                fprintf(2,'\nCurrent results file was not generated correctly!\n');
                this.deleteFile(name_cur);
                status = rmdir(drv.path_out); %#ok<NASGU>
                return;
            end
            
            % Compare contents of files
            file_ref = javaObject('java.io.File',name_ref);
            file_cur = javaObject('java.io.File',name_cur);
            is_equal = javaMethod('contentEquals','org.apache.commons.io.FileUtils',file_ref,file_cur);
            if (is_equal)
                fprintf(1,'\nTest passed!\n');
            else
                fprintf(2,'\nResults are different!\n');
            end
            
            % Delete current results file and folder (if empty)
            this.deleteFile(name_cur);
            status = rmdir(drv.path_out); %#ok<NASGU>
        end
        
        %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
        function renameRefResultFile(this,drv)
            % Check if current results file exist
            name_cur = strcat(drv.path_out,drv.name,".pos");
            if (exist(name_cur,'file') ~= 2)
                fprintf(2,'\nCurrent results file was not generated correctly!\n');
                this.deleteFile(name_cur);
                status = rmdir(drv.path_out); %#ok<NASGU>
                return;
            end
            
            % Move current results file out of output folder
            if (~movefile(name_cur,drv.path_in))
                fprintf(2,'\nCurrent results file was not generated correctly!\n');
                this.deleteFile(name_cur);
                status = rmdir(drv.path_out); %#ok<NASGU>
                return;
            end
            
            % Delete output folder (if empty)
            status = rmdir(drv.path_out); %#ok<NASGU>
            
            % Rename current results file to reference results file
            name_cur = strcat(drv.path_in,drv.name,".pos");
            name_ref = strcat(drv.path_in,drv.name,"_ref.pos");
            movefile(name_cur,name_ref);
            fprintf(1,'\nReference results generated!\n');
        end
        
        %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
        function deleteFile(~,file_name)
            if (exist(file_name,'file') == 2)
                warning off MATLAB:DELETE:FileNotFound
                delete(sprintf('%s',file_name));
                warning on MATLAB:DELETE:FileNotFound
            end
        end
        
        %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
        % To be called before the analysis (currently not available)
        function startParallel(~,drv)
            p = gcp('nocreate');
            if (drv.parallel)
                max_workers = parcluster('local').NumWorkers;
                if (drv.workers > max_workers)
                    drv.workers = max_workers;
                    warning('off','backtrace');
                    warning('The selected number of workers is greater than the available number of workers in this machine. The simulation will proceed with the %d available workers',max_workers);
                    warning('on','backtrace');
                end
                if (isempty(p))
                    fprintf('\n');
                    parpool(drv.workers);
                elseif (p.NumWorkers ~= drv.workers)
                    fprintf('\n');
                    delete(p)
                    parpool(drv.workers);
                end
            elseif (~isempty(p))
                fprintf('\n');
                delete(p);
            end
            ps = parallel.Settings;
            ps.Pool.AutoCreate = false;
        end
    end
end
##### SOURCE END #####
--></body></html>